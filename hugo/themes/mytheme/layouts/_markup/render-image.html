{{- /*
  render-image.html
  MD内の画像参照を公開URLに変換するRender Hook

  入力（.Destination）の例:
    attachments/2026-02-20-test-article3--hero-01.jpg  → /blog/2026-02-20-test-article3/hero-01.webp
    attachments/about--profile.jpg                     → /about/profile.webp
    attachments/_index--hero.jpg                       → /hero.webp

  変換ルール:
    1. "attachments/" プレフィックスを除去してファイル名を取得
    2. "--" でスラグとnameに分割
    3. スラグが "_index" の場合はルート直下 → /{name}.webp
    4. .Page.Section がある場合 → /{section}/{slug}/{name}.webp
    5. .Page.Section がない場合（about等）→ /{slug}/{name}.webp
    6. "--" が含まれない場合はそのまま出力（変換対象外）
*/ -}}

{{- $dest := .Destination -}}
{{- $src := $dest -}}

{{- if and (hasPrefix $dest "attachments/") (strings.Contains $dest "--") -}}
  {{- $filename := strings.TrimPrefix "attachments/" $dest -}}
  {{- $ext := path.Ext $filename -}}
  {{- $nameNoExt := strings.TrimSuffix $ext $filename -}}

  {{- $slug := index (split $nameNoExt "--") 0 -}}
  {{- $name := strings.TrimPrefix (printf "%s--" $slug) $nameNoExt -}}

  {{- if eq $slug "_index" -}}
    {{- /* トップページ用: ルート直下 */}}
    {{- $src = printf "/%s.webp" $name -}}
  {{- else if ne .Page.Section "" -}}
    {{- /* blog等セクションページ */}}
    {{- $src = printf "/%s/%s/%s.webp" .Page.Section $slug $name -}}
  {{- else -}}
    {{- /* about等セクションなしページ: スラグがそのままパス */}}
    {{- $src = printf "/%s/%s.webp" $slug $name -}}
  {{- end -}}
{{- end -}}

<figure>
<img src="{{ $src | safeURL }}"
     alt="{{ .Text }}"
     loading="lazy"
     {{- with .Title }} title="{{ . }}"{{ end }}>
{{- with .Title }}
<figcaption>{{ . }}</figcaption>
{{- end }}
</figure>
