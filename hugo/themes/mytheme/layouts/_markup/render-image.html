{{- /*
  render-image.html
  MD内の画像参照を公開URLに変換するRender Hook

  入力（.Destination）の例:
    attachments/2026-02-20-test-article3--hero-01.jpg

  出力URLの例:
    /blog/2026-02-20-test-article3/hero-01.webp

  変換ルール:
    1. "attachments/" プレフィックスを除去してファイル名を取得
    2. "--" でスラグとnameに分割
    3. 拡張子を .webp に変換
    4. /{section}/{slug}/{name}.webp の形式でURLを組み立て

  "--" が含まれない場合はそのまま出力する（変換対象外）
*/ -}}

{{- $dest := .Destination -}}
{{- $src := $dest -}}

{{- if and (hasPrefix $dest "attachments/") (strings.Contains $dest "--") -}}
  {{- $filename := strings.TrimPrefix "attachments/" $dest -}}
  {{- $ext := path.Ext $filename -}}
  {{- $nameNoExt := strings.TrimSuffix $ext $filename -}}

  {{- /* "--" で分割: replaceを1回だけ行いスラグを取得、nameは末尾から取得 */}}
  {{- $slug := index (split $nameNoExt "--") 0 -}}
  {{- $afterSlug := strings.TrimPrefix (printf "%s--" $slug) $nameNoExt -}}

  {{- $section := .Page.Section -}}
  {{- $src = printf "/%s/%s/%s.webp" $section $slug $afterSlug -}}
{{- end -}}

<figure>
<img src="{{ $src | safeURL }}"
     alt="{{ .Text }}"
     loading="lazy"
     {{- with .Title }} title="{{ . }}"{{ end }}>
{{- with .Title }}
<figcaption>{{ . }}</figcaption>
{{- end }}
</figure>
